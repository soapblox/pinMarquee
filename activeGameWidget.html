<html>
    <head>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
        <script src="marquee.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <style>
            .activeGame {
                background-color: black;
                color: white;
                font-family: Tahoma, Geneva, sans-serif;
            }
        </style>
    </head>
    <body style="background-color: black;">

        <span style="width: 1200px" id="activeGamesDiv"></span>
        
        <script>
            var pinMarquee = new PinMarquee();
            var activeGameQueueIndex = 0;
            var currentTournamentIndex = 0;

            var started = false;

            function drawCurrentActiveGameFromQueue() {
                var theString = "<span class='activeGame'>";

                var aMatch = fetchNextActiveMatch();

                theString += "** R" + aMatch.round + ". " + aMatch.player1.name + " (" + aMatch.player1Score + "-" + aMatch.player2Score + ") " + aMatch.player2.name + " ** ";

                aMatch = fetchNextActiveMatch();

                theString += "** R" + aMatch.round + ". " + aMatch.player1.name + " (" + aMatch.player1Score + "-" + aMatch.player2Score + ") " + aMatch.player2.name + " ** ";

                theString += "</span>"
                fadeExistingAndLoadNew(theString);
            }

            function fetchNextActiveMatch() {
            
                var found = false;
                var aMatch;
                while (!found) {
                    aMatch = pinMarquee.tournaments[currentTournamentIndex].matches[activeGameQueueIndex];
                    if (aMatch.state == "open") {
                        //console.log('active game found' + aMatch.id);
                        found = true;
                    }
                    else {
                        //console.log("matchIndex " + activeGameQueueIndex + " is not open");
                    }

                    // finished with current tournament, switch to next...
                    activeGameQueueIndex++;
                    if (activeGameQueueIndex == pinMarquee.tournaments[currentTournamentIndex].matches.length) {
                        activeGameQueueIndex = 0;
                        currentTournamentIndex++;

                        // finished all tournaments, go back to beginning...
                        if (currentTournamentIndex == pinMarquee.tournaments.length) {
                            currentTournamentIndex = 0;
                        }                        
                    }
                }

                return aMatch;
            }

            $(function () {

                var socket = io();
                window['taco'] = socket;
              //  window['taco'].emit("startPlayerWidget", "startPlayerWidget");

                socket.on("activeGameStateUpdate", function(msg) {
                    console.log("in activeGameStateUpdate");

                    var tempMarquee = JSON.parse(msg);

                    console.log(tempMarquee);

                    // copy over the tournaments....
                    for (var i = 0; i < tempMarquee.tournaments.length; i++) {
                        pinMarquee.tournaments[i] = new Tournament();
                        pinMarquee.tournaments[i].players = tempMarquee.tournaments[i].players;
                        pinMarquee.tournaments[i].matches = tempMarquee.tournaments[i].matches;
                    }

                    //console.log(pinMarquee);

                    if (!started) {
                        started = true;
                        playerTimer = new interval(4000, drawCurrentActiveGameFromQueue);
                        playerTimer.run();
                    }
                })
            });

            function fadeExistingAndLoadNew(newStuff) {
                var options = { direction: "down"};
                $("#activeGamesDiv").effect("drop", options, 400);
                setTimeout(drawNew, 500, newStuff);
                
            }

            function drawNew(newStuff) {
                //console.log("in drawNew");
                $("#activeGamesDiv").hide();
                $("#activeGamesDiv").html(newStuff);
                var options = { direction: "up"};
                $("#activeGamesDiv").show("drop", options);
            }

        </script>
    </body>
</html>