<html>
    <head>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>        
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

        <style>
            .scoreChange {
                background-color: black;
            }

            .matchChange {
                background-color: black;
            }
            .eventList {
                color: #BCBEC0;
                font-family: Calibri;
            }

            .winner {
                font-weight: bold;
                color: #E2CF20;
            }

            .currentTournament {
                color: #E2CF20;
            }

            .eventSpan {
                width: 600px;
                padding: 5px;
            }
        </style>
    </head>
    <body style="background-color: black;">

        <span class="eventList" style="background-color: black; width: 1800px" id="eventsDiv"></span>
        <script>

            var pinEvents = [];
            var pinEventsIndex = 0;
            var displayEventsSize = 2; 
            var eventsBeingDisplayed = 0;

            $(function () {

                var socket = io();
                window['taco'] = socket;
              //  window['taco'].emit("startPlayerWidget", "startPlayerWidget");

                socket.on("updatePinEvents", function(msg) {
                    console.log("in updatePinEvents");
                    var newEvents = JSON.parse(msg);
                    console.log("we just got events: " + newEvents.length);
                    console.log(newEvents);

                    if (newEvents.length > 0) {
                        console.log("actually got events!");
                        var updateEvent = {};
                        updateEvent.type = "newUpdate";
                        pinEvents.push(updateEvent);
                    }

                    newEvents.forEach(function(anEvent) {
                       // console.log("pushing...");
                        //console.log(anEvent);
                        pinEvents.push(anEvent);
                        $("#queueSize").html(pinEvents.length);
                    })
                });
            });


            function addEvent() {
                pinEvents.push("Taco");
                $("#queueSize").html(pinEvents.length);
            }

            function drawEvents() {

               // console.log("in drawEvents...");

                if (pinEventsIndex == pinEvents.length) {
                    //console.log("No events to draw");
                    return;
                }

                // console.log("drawing an event...");
                var aEvent = pinEvents[pinEventsIndex];
                
                var theSpan = "<span class='eventSpan' style='display: none' id='eventSpan" + pinEventsIndex + "'>";

                if (aEvent.type == "newUpdate") {
                    theSpan += "<span class='update'>UPDATE</span>";
                }
                else {
                    // theSpan.style.display = "none";
                    // theSpan.id = "eventSpan" + pinEventsIndex;
                    // var theEventText = "";

                    // do the round
                    theSpan += "<span class='currentTournament'>" + aEvent.tournamentName + "</span> | <span class='round'>R" + aEvent.round + ". - </span>";
                    
                    if (aEvent.type == "matchChange" && aEvent.player1Wins) {
                        theSpan += "<span class='winner'>" + aEvent.player1_name + "</span>"; 
                    }
                    else {
                        theSpan +=  aEvent.player1_name; 
                    }
                    
                    theSpan += " (";
                    
                    if ((aEvent.type == "scoreChange" && aEvent.player1ScoreChanged) || (aEvent.type == "matchChange" && aEvent.player1Wins)) {
                        theSpan += "<span class='winner'>" + aEvent.player1Score +  "</span>";
                    }
                    else {
                        theSpan += aEvent.player1Score;
                    }
                    
                    theSpan += "-";
                    //theEventText += ") " + aEvent.player2_name;

                    if ((aEvent.type == "scoreChange" && aEvent.player2ScoreChanged) || (aEvent.type == "matchChange" && !aEvent.player1Wins)) {
                        theSpan += "<span class='winner'>" + aEvent.player2Score +  "</span>";
                    }
                    else {
                        theSpan += aEvent.player2Score;
                    }

                    theSpan += ") ";

                    if (aEvent.type == "matchChange" && !aEvent.player1Wins) {
                        theSpan += "<span class='winner'>" + aEvent.player2_name + "</span>"; 
                    }
                    else {
                        theSpan += aEvent.player2_name; 
                    }
                }

                theSpan += " | </span>";
                //var theText = document.createTextNode(theEventText);
                console.log(theSpan);
               // $("#" + theSpan.id).html(theEventText);
                $("#queueIndex").html(pinEventsIndex);
                $("#eventsDiv").append(theSpan);

                console.log(aEvent.type);

                var options = { direction: "left"};

                // event queue not full...
                if (eventsBeingDisplayed < displayEventsSize) {
                    eventsBeingDisplayed++;
                }
                else {
                    console.log("event queue full, remove last");
                    var spanToFade = $("#eventSpan" + (pinEventsIndex - displayEventsSize)).hide("drop", options);
                }

                $("#eventSpan" + pinEventsIndex).addClass(aEvent.type);

                options = { direction: "right"};
                $("#eventSpan" + pinEventsIndex).show("drop", options);

                pinEventsIndex++;

            }

            var theTimer = setInterval(drawEvents, 5000);

        </script>

        <br /> <br />
        <br /> <br />
        <br /> <br />
        <br /> <br />
        <br /> <br />
        
        <button onclick="addEvent()">add event</button>
        <button onclick="drawEvents()">draw event</button>

        <br />

        queue size: <span id="queueSize"></span> <br />
        queue index: <span id="queueIndex"></span> <br />
        
    </body>
</html>