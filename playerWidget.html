<html>
    <head>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>        
        <script src="/socket.io/socket.io.js"></script>
        <script src="marquee.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    </head>
    <body style="background-color: black;">
        <style>
            .currentPlayer {
                background-color: black;
                color: white;
                font-family: Tahoma, Geneva, sans-serif;
            }
        </style>

        <span style="width: 500px; background-color: black;" id="currentPlayerDiv"></span>
        <script>

            var pinMarquee = new PinMarquee();
            var playerTimer;

            var playersIndex = 0;
            var womansIndex = 0;

            var drawNationals = true;

            var started = false;

            function makePlayerMatchesString(playerMatches, currentPlayerId) {
                var theString = ""
                playerMatches.forEach(function(aMatch, index) {
                    // for Player List, we always want the CURRENT Player score displayed on the LEFT
                    // so if the CURRENT Player is actually player 2, we swap the score string...
                    if (currentPlayerId == aMatch.player1.id) {
                        theString += " R" + aMatch.round + ". (" +  aMatch.player1Score + "-" + aMatch.player2Score + ")";
                        //console.log("player is player 1");
                    }
                    else {
                        theString += " R" + aMatch.round + ". (" +  aMatch.player2Score + "-" + aMatch.player1Score + ")";
                        //console.log("player is player 2");
                    }
                    
                });

                return theString;
            }

            function drawCurrentPlayer() {
                var playersToUse;
                var currentPlayer = "<span class='currentPlayer'>";
                if (drawNationals) {
                    currentPlayer += pinMarquee.players[playersIndex].name;
                    var currentPlayerId = pinMarquee.players[playersIndex].id;

                    //console.log(currentPlayer);

                    currentPlayer += makePlayerMatchesString(pinMarquee.getMatchesByPlayerId(currentPlayerId), currentPlayerId);

                    // $("#currentPlayerDiv").html(currentPlayer + matchString);
                    playersIndex++;

                    // reset the loop, switch to women's...
                    if (playersIndex == pinMarquee.players.length) {
                        playersIndex = 0;
                        drawNationals = false;
                    }
                }
                else {
                    currentPlayer += pinMarquee.womens[womansIndex].name;
                    var currentPlayerId = pinMarquee.womens[womansIndex].id;

                    //console.log(currentPlayer);

                    currentPlayer += makePlayerMatchesString(pinMarquee.getWomansMatchesByPlayerId(currentPlayerId), currentPlayerId);

                    // $("#currentPlayerDiv").html(currentPlayer + matchString);
                    womansIndex++;

                    // reset the loop, switch to women's...
                    if (womansIndex == pinMarquee.womens.length) {
                        womansIndex = 0;
                        drawNationals = true;
                    }
                }
                

                

                currentPlayer += "</span>"

                fadeExistingAndLoadNew(currentPlayer);
            }


            $(function () {

                var socket = io();
                window['taco'] = socket;
                window['taco'].emit("startPlayerWidget", "startPlayerWidget");

                socket.on("paintPlayer", function(msg) {
                    console.log("in paintWidget");
                    fadeExistingAndLoadNew(msg);
                })

                socket.on("playerStateUpdate", function(msg) {
                    console.log("in playerStateUpdate");

                    var tempMarquee = JSON.parse(msg);
                    
                    pinMarquee.players = tempMarquee.players;
                    pinMarquee.matches = tempMarquee.matches;
                    pinMarquee.womens = tempMarquee.womens;
                    pinMarquee.womensMatches = tempMarquee.womensMatches;

                    console.log(pinMarquee);

                    if (!started) {
                        started = true;
                        playerTimer = new interval(1000, drawCurrentPlayer);
                        playerTimer.run();
                    }
                })
            });

            function fadeExistingAndLoadNew(newStuff) {
                var options = { direction: "down"};
                $("#currentPlayerDiv").effect("drop", options, 400);
                setTimeout(drawNew, 500, newStuff);
                
            }

            function drawNew(newStuff) {
               // console.log("in drawNew");
                $("#currentPlayerDiv").hide();
                $("#currentPlayerDiv").html(newStuff);
                var options = { direction: "up"};
                $("#currentPlayerDiv").show("drop", options);
            }
        </script>
    </body>
</html>