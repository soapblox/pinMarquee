<html>

<head>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="marquee.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        var logDebug = false;
        var tournamentId = "";
        var apiKey = "";
        var cUrl = "https://api.challonge.com/v1/tournaments";

        var userUri;
        var matchesUri;
        var numOfPlayers = 0;
        var numOfMatches = 0;

        var matches = [];
        var players = [];

        var myTimer;
        var playerMarqueeTimer;

        var timerInterval = 0;

        var activeGameQueue = [];
        var activeGameQueueIndex = 0;
        var activeGameTimer;

        var pinMarquee = new PinMarquee();

        var pinEventQueue = [];
        var pinEventCurrentIndex = 0;

        var playersQueue = [];
        var playersIndex = 0;



        $(document).ready(function() {

            $("#updateButton").on("click", function() {
                
                tournamentId = $("#tournamentId").val();
                apiKey = $("#apiKey").val();
                timerInterval = 1000 * parseInt($("#pollingSecs").val());

                console.log("setting tournamentId: " + tournamentId + ", apiKey: " + apiKey + ", interval: " + timerInterval, true);
            });

            $("#getPlayers").on("click", function() {
                var callingUrl = cUrl + "/" + tournamentId + "/participants.json?api_key=" + apiKey;
                doLogging("calling URL: " + callingUrl);
                $.ajax({
                    url: callingUrl,
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {

                    numOfPlayers = data.length;
                    for (var i = 0; i < numOfPlayers; i++) {
                        
                        var aPlayer = new Player();
                        
                        aPlayer.id = data[i].participant.id;
                        aPlayer.name = data[i].participant.display_name;
                        players.push(aPlayer);
                        pinMarquee.players.push(aPlayer);
                    }

                    console.log(numOfPlayers + " players loaded...", pinMarquee.players);
                });
            });

            $("#startPolling").on("click", fetchMatches);
            $("#stopPolling").on("click", stopPolling);

            $("#startPlayerMarquee").on("click", startPlayerMarquee);
            $("#stopPlayerMarquee").on("click", stopPlayerMarquee);

            $("#startActiveGameMarquee").on("click", startActiveGameMarquee);

            $("#getMatches").on("click", function() {
                var callingUrl = cUrl + "/" + tournamentId + "/matches.json?api_key=" + apiKey;
                //doLogging("calling URL: " + callingUrl);
                $.ajax({
                    url: callingUrl,
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {

                    var challongeData = parseChallongeMatches(data);

                    matches = challongeData;
                    pinMarquee.matches = challongeData;

                    console.log(pinMarquee.matches.length + " matches loaded..."); 

                });
            });
        });

        function fetchMatches() {
            var callingUrl = cUrl + "/" + tournamentId + "/matches.json?api_key=" + apiKey;
            $.ajax({
                url: callingUrl,
                dataType: "json",
                method: "GET"
            }).done(function(data) {

                var challongeData = parseChallongeMatches(data);

                var pinEventChanges = processMatchUpdate(challongeData);

                console.log(pinEventChanges);

                window['taco'].emit('pinEvents', JSON.stringify(pinEventChanges));
            });
        }

        function processMatchUpdate(challongeData) {
            var deltaEvents = []
            for (var i = 0; i < matches.length; i++) {
                if (matches[i].id == challongeData[i].id) {
                    if (matches[i].state != challongeData[i].state) {
                        console.log("we have a state change... copy it over");
                        matches[i].state = challongeData[i].state
                        matches[i].player2_name = challongeData[i].player2_name;
                        matches[i].player1_name = challongeData[i].player1_name;
                        matches[i].player1Score = challongeData[i].player1Score;
                        matches[i].player2Score = challongeData[i].player2Score;
                    }
                    if (matches[i].matchScore == challongeData[i].matchScore) {
                        console.log("nothing changed.." + challongeData[i].matchScore);
                    }
                    else {
                        // when something changes, we copy the results from the server to
                        // the values inside our "System of Record": the matches array.
                        console.log("something changed!");

                        // Figure out exactly what changed...
                        var player1ScoreChanged = false;
                        var player2ScoreChanged = false;
                        
                        matches[i].matchScore = challongeData[i].matchScore;

                        if (matches[i].player1Score != challongeData[i].player1Score) {
                            console.log("player1 score changed");
                            player1ScoreChanged = true;
                        }

                        if (matches[i].player2Score != challongeData[i].player2Score) {
                            console.log("player2 score changed");
                            player2ScoreChanged = true;
                        }

                        // UPDATE THE SCORE in SOR
                        matches[i].player1Score = challongeData[i].player1Score;
                        matches[i].player2Score = challongeData[i].player2Score;
                        
                        // add EVENT
                        var pinEvent = {};
                        pinEvent.matchId = matches[i].id;

                        // indicate if player1 Score has changed in this update..
                        pinEvent.player1Score = player1ScoreChanged ? "*" + matches[i].player1Score + "*" : matches[i].player1Score;
                        pinEvent.player1_name = matches[i].player1_name;

                        // indicate if player2 Score has changed in this update..
                        pinEvent.player2Score = player2ScoreChanged ? "*" + matches[i].player2Score + "*" : matches[i].player2Score;
                        pinEvent.player2_name = matches[i].player2_name;

                        // same state, it's just a score change...
                        if (matches[i].state == challongeData[i].state) {
                            pinEvent.type = "scoreChange";
                        }
                        else {  // somebody won!  change their state in SOR
                            pinEvent.type = "matchChange";
                            matches[i].state = challongeData.state
                        }

                        deltaEvents.push(pinEvent);

                    }
                    
                }
            }
            return deltaEvents;
        }

        function sendCurrentState() {
            var currentState = {};
            currentState.players = players;
            currentState.matches = matches;

            //window['taco'].emit("panelToPlayerUpdate", JSON.stringify(currentState));
        }

        function drawEventQueue() {
            pinEventQueue.forEach(function(pinEvent) {
                console.log(pinEvent);
            })
        }

        // ************* PLAYER

        function startPlayerMarquee() {
            // SEND THE CURRENT STATE TO THE WIDGET
            window['taco'].emit("panelToPlayerUpdate", JSON.stringify(pinMarquee));

            console.log("playerMarquee started");
        }

        function stopPlayerMarquee() {
            clearInterval(playerMarqueeTimer);
        }

        
        // ********** ACTIVE GAME

        function startActiveGameMarquee() {
            // always paint the first one RIGHT NOW...
           // drawCurrentActiveGameFromQueue();

            // SEND THE CURRENT STATE TO THE WIDGET
            window['taco'].emit("panelToActiveGameUpdate", JSON.stringify(pinMarquee));

            // then every 10 seconds
            //activeGameTimer = new interval(8000, drawCurrentActiveGameFromQueue);
            //activeGameTimer.run();

            //console.log("drawCurrentActiveGameFromQueue started");
        }

        function stopActiveGameMarquee() {
            clearInterval(activeGameTimer);
            doLogging("playerMarqueeTimer stopped...", true);
        }

        function startPolling() {
            doLogging("challonge polling started...", true);
            myTimer = setInterval(processMatches, parseInt(timerInterval));
        }

        function stopPolling() {
            clearInterval(myTimer);
            doLogging("challonge polling stopped...", true);
        }        

        function processMatches() {
            doLogging("start processMatches...", true);
            
        }

        function parseChallongeMatches(data) {
            var challongeMatches = [];
            numOfMatches = data.length;
            for (var i = 0; i < numOfMatches; i++) {
                var aMatch = new Match();
                
                aMatch.id = data[i].match.id;
                aMatch.state = data[i].match.state;
                aMatch.player1 = getPlayerById(data[i].match.player1_id);
                aMatch.player2 = getPlayerById(data[i].match.player2_id);
                aMatch.matchScore = data[i].match.scores_csv;
                aMatch.round = data[i].match.round;

                aMatch.player1Score = aMatch.matchScore.substring(0, 1);
                aMatch.player2Score = aMatch.matchScore.substring(2, 3);

                //console.log(aMatch.player1Score + " " + aMatch.player2Score);
                //doLogging(aMatch, true);
                challongeMatches.push(aMatch);
            }

            console.log(challongeMatches);

            return challongeMatches;
        }

        function getMatchesByPlayerId(pId) {
            var playerMatches = [];
            //console.log(pId);
            for (var i = 0; i < matches.length; i++) {
                //console.log(matches[i].player1_id);
                //console.log(matches[i].player2_id);
                if (matches[i].player1_id == pId || matches[i].player2_id == pId) {
                    //console.log("found player match...");
                    //console.log(matches[i]);
                    playerMatches.push(matches[i]);
                }
            }

            return playerMatches;
        }

        function makePlayerMatchesString(playerMatches) {
            var theString = ""
            playerMatches.forEach(function(aMatch, index) {
                theString += "R" + aMatch.round + ". (" +  aMatch.player1Score + "-" + aMatch.player2Score + ")";
            });

            return theString;
        }

        function getPlayerById(pId) {
             // match doesn't know what player it is yet, so ignore...
             if (pId == null) {
                return;
            }
            console.log(players.length);
            for (var i = 0; i < players.length; i++) {
                if (players[i].id == pId) {
                    return players[i];
                }
            }
        }

        function getPlayerNameById(pId) {
            // match doesn't know what player it is yet, so ignore...
            if (pId == null) {
                return;
            }

            for (var i = 0; i < players.length; i++) {
                if (players[i].id == pId) {
                    return players[i].name;
                }
            }

            console.log("PlayerID not found: " + pId);
        }

        function fetchNextActiveMatch() {
            
            var found = false;
            var aMatch;
            while (!found) {
                aMatch = matches[activeGameQueueIndex];
                if (aMatch.state == "open") {
                    //console.log('active game found' + aMatch.id);
                    found = true;
                }
                else {
                    //console.log("matchIndex " + activeGameQueueIndex + " is not open");
                }

                // increment... reset the loop if necessary
                activeGameQueueIndex++;
                if (activeGameQueueIndex == matches.length) {
                    activeGameQueueIndex = 0;
                }

                
            }

            return aMatch;
        }

        function drawCurrentActiveGameFromQueue() {
            var theString = "";

            var aMatch = fetchNextActiveMatch();

            theString += "** " + aMatch.player1_name + " (" + aMatch.player1Score + "-" + aMatch.player2Score + ") " + aMatch.player2_name + " ** ";

            aMatch = fetchNextActiveMatch();

            theString += "** " + aMatch.player1_name + " (" + aMatch.player1Score + "-" + aMatch.player2Score + ") " + aMatch.player2_name + " ** ";

            //$("#activeGameDiv").html(theString);
            window['taco'].emit("setActiveGames", theString);
        }


        function doLogging(logString, forceLog) {
            if (forceLog) {
                //console.log(logString);
            }

            if (logDebug) {
               // console.log(logString);
            }
        }
    </script>
</head>
<body>
    <h2>Challonge Admin Panel</h2>
    <p style="border: 1px solid black; padding: 5px">
        TournamentId: <input type="text" id="tournamentId" value="8113412" size="10" /> <br />
        WomensId: <input type="text" id="womensId" value="8113412" size="10" /> <br />
        API Key: <input type="text" id="apiKey" value="FamWkhEPZ2bM6QCRVRZXZoIWatyEmRvepJf3odHx" size="50" /> <br />
        Challonge Update Interval: <input type="text" id="pollingSecs" value="60" size="4"/> seconds <br />
        <button id="updateButton">Update</button> 
    </p>
    <p>
        <button id="getPlayers">Load Players</button>
        <button id="getMatches">Matches</button>
        <button id="startPolling">Start Polling</button>
        <button id="stopPolling">Stop Polling</button>
        <button id="startPlayerMarquee">Start Player Marquee</button>
        <button id="stopPlayerMarquee">Stop Player Marquee</button>
        <button id="startActiveGameMarquee">Start Active Game</button>
        
    </p>

    Active Games:<br />
    <iframe width="1000" height="30" src="/activeGameWidget" scrolling="no"></iframe>

    <br /> <br />
    
    <!-- <marquee id="theMarquee" width="300" onfinish="console.log('bouncy')"></marquee><br /> 

    Past: <marquee id="previousRounds" scrollDelay="200" width="300" onfinish="console.log('bouncy')"></marquee> <br /> -->

    Current Player: <div id="currentPlayerDiv" style="width: 500">
    <iframe width="1000" height="30" src="/playerWidget"></iframe>
    </div> <br />

    Event Log: <br /> 

    <!-- <iframe width="400" height="90" src="/eventWidget" scrolling="no"></iframe> -->

    <script>
            $(function () {

                var socket = io();
                window['taco'] = socket;
                window['taco'].emit("startWidget", "startWidget");
            });

    </script>
</body>
</html>



