<html>

<head>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="marquee.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        var logDebug = false;
        var tournamentId = "";
        var womansId = "";
        var apiKey = "";
        var cUrl = "https://api.challonge.com/v1/tournaments";

        var userUri;
        var matchesUri;
        var numOfPlayers = 0;
        var numOfMatches = 0;

        var myTimer;
        var playerMarqueeTimer;

        var timerInterval = 0;

        var pinMarquee = new PinMarquee();

        $(document).ready(function() {

            $("#loadButton").on("click", function() {
                
                tournamentId = $("#tournamentId").val();
                womansId = $("#womensId").val();
                apiKey = $("#apiKey").val();
                timerInterval = 1000 * parseInt($("#pollingSecs").val());

                console.log("National tournamentId: " + tournamentId + ", womansId: " + womansId + ", apiKey: " + apiKey + ", interval: " + timerInterval);

                // load Nationals Players...
                var nationalsPlayerUrl = cUrl + "/" + tournamentId + "/participants.json?api_key=" + apiKey;
                var womansPlayerUrl = cUrl + "/" + womansId + "/participants.json?api_key=" + apiKey;
                var callingUrl = cUrl + "/" + tournamentId + "/matches.json?api_key=" + apiKey;

                $.ajax({
                    url: nationalsPlayerUrl,
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {

                    numOfPlayers = data.length;
                    for (var i = 0; i < numOfPlayers; i++) {
                        
                        var aPlayer = new Player();
                        
                        aPlayer.id = data[i].participant.id;
                        aPlayer.name = data[i].participant.display_name;
                        //players.push(aPlayer);
                        pinMarquee.players.push(aPlayer);
                    }

                    console.log(pinMarquee.players.length + " National players loaded...");

                    var nationalsMatchesUrl = cUrl + "/" + tournamentId + "/matches.json?api_key=" + apiKey;
                    $.ajax({
                        url: nationalsMatchesUrl,
                        dataType: "json",
                        method: "GET"
                    }).done(function(data) {
                        pinMarquee.matches = parseChallongeMatches(data);
                        console.log(pinMarquee.matches.length + " National matches loaded...");
                    });                    
                });

                $.ajax({
                    url: womansPlayerUrl,
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {

                    numOfPlayers = data.length;
                    for (var i = 0; i < numOfPlayers; i++) {
                        
                        var aPlayer = new Player();
                        
                        aPlayer.id = data[i].participant.id;
                        aPlayer.name = data[i].participant.display_name;
                        //players.push(aPlayer);
                        pinMarquee.players.push(aPlayer);
                    }

                    console.log(pinMarquee.players.length + " Women players loaded...");
                    var womansMatchesUrl = cUrl + "/" + womansId + "/matches.json?api_key=" + apiKey;

                    $.ajax({
                        url: womansMatchesUrl,
                        dataType: "json",
                        method: "GET"
                    }).done(function(data) {
                        pinMarquee.womensMatches = parseChallongeMatches(data);
                        console.log(pinMarquee.womensMatches.length + " Womens matches loaded...");
                    });
                    
                    

                });
            });

            $("#getPlayers").on("click", function() {
                var callingUrl = cUrl + "/" + tournamentId + "/participants.json?api_key=" + apiKey;
                doLogging("calling URL: " + callingUrl);
                $.ajax({
                    url: callingUrl,
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {

                    numOfPlayers = data.length;
                    for (var i = 0; i < numOfPlayers; i++) {
                        
                        var aPlayer = new Player();
                        
                        aPlayer.id = data[i].participant.id;
                        aPlayer.name = data[i].participant.display_name;
                        //players.push(aPlayer);
                        pinMarquee.players.push(aPlayer);
                    }

                    console.log(numOfPlayers + " players loaded...", pinMarquee.players);
                });
            });

            $("#startPolling").on("click", fetchMatches);
            $("#stopPolling").on("click", stopPolling);

            $("#startPlayerMarquee").on("click", startPlayerMarquee);
            $("#stopPlayerMarquee").on("click", stopPlayerMarquee);

            $("#startActiveGameMarquee").on("click", startActiveGameMarquee);

            $("#getMatches").on("click", function() {
                var callingUrl = cUrl + "/" + tournamentId + "/matches.json?api_key=" + apiKey;
                //doLogging("calling URL: " + callingUrl);
                $.ajax({
                    url: callingUrl,
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {

                    var challongeData = parseChallongeMatches(data);

                    matches = challongeData;
                    pinMarquee.matches = challongeData;

                    console.log(pinMarquee.matches.length + " matches loaded..."); 

                });
            });
        });

        function loadMatches(tId) {
            var callingUrl = cUrl + "/" + tId + "/matches.json?api_key=" + apiKey;
                //doLogging("calling URL: " + callingUrl);
                $.ajax({
                    url: callingUrl,
                    dataType: "json",
                    method: "GET"
                }).done(function(data) {

                    var challongeData = parseChallongeMatches(data);

                    return challongeData;

                    //console.log(pinMarquee.matches.length + " matches loaded..."); 

                });
        }

        function fetchMatches() {
            var callingUrl = cUrl + "/" + tournamentId + "/matches.json?api_key=" + apiKey;
            $.ajax({
                url: callingUrl,
                dataType: "json",
                method: "GET"
            }).done(function(data) {

                var challongeData = parseChallongeMatches(data);

                

                var pinEventChanges = processMatchUpdate(challongeData);

                console.log(pinEventChanges);

                // send update pinMarquee to player/game widgets...
                window['taco'].emit('panelToPlayerUpdate', JSON.stringify(pinMarquee));
                window['taco'].emit('panelToActiveGameUpdate', JSON.stringify(pinMarquee));

                // send delts to event widget...
                window['taco'].emit('pinEvents', JSON.stringify(pinEventChanges));
            });
        }

        /**
         * This function updates the System of Record copy of PinMarquee with the fresh values
         * fetched from the server.  The DELTAS are returned as a PinEvent array.
         */
        function processMatchUpdate(challongeData) {
            var deltaEvents = []
            var theMatches = pinMarquee.matches;
            for (var i = 0; i < theMatches.length; i++) {
                if (theMatches[i].id == challongeData[i].id) {
                    if (theMatches[i].state != challongeData[i].state) {
                        console.log("we have a state change... copy it over");
                        theMatches[i].state = challongeData[i].state
                        theMatches[i].player1 = challongeData[i].player1;
                        theMatches[i].player2 = challongeData[i].player2;
                        theMatches[i].player1Score = challongeData[i].player1Score;
                        theMatches[i].player2Score = challongeData[i].player2Score;
                    }
                    if (theMatches[i].matchScore == challongeData[i].matchScore) {
                        console.log("nothing changed.." + challongeData[i].matchScore);
                    }
                    else {
                        // when something changes, we copy the results from the server to
                        // the values inside our "System of Record": the matches array.
                        console.log("something changed!");

                        // Figure out exactly what changed...
                        var player1ScoreChanged = false;
                        var player2ScoreChanged = false;
                        
                        theMatches[i].matchScore = challongeData[i].matchScore;

                        if (theMatches[i].player1Score != challongeData[i].player1Score) {
                            console.log("player1 score changed");
                            player1ScoreChanged = true;
                        }

                        if (theMatches[i].player2Score != challongeData[i].player2Score) {
                            console.log("player2 score changed");
                            player2ScoreChanged = true;
                        }

                        // UPDATE THE SCORE in SOR
                        theMatches[i].player1Score = challongeData[i].player1Score;
                        theMatches[i].player2Score = challongeData[i].player2Score;
                        
                        // add EVENT
                        var pinEvent = {};
                        pinEvent.matchId = theMatches[i].id;

                        // indicate if player1 Score has changed in this update..
                        pinEvent.player1Score = player1ScoreChanged ? "*" + theMatches[i].player1Score + "*" : theMatches[i].player1Score;
                        pinEvent.player1_name = theMatches[i].player1.name;

                        // indicate if player2 Score has changed in this update..
                        pinEvent.player2Score = player2ScoreChanged ? "*" + theMatches[i].player2Score + "*" : theMatches[i].player2Score;
                        pinEvent.player2_name = theMatches[i].player2.name;

                        // same state, it's just a score change...
                        if (theMatches[i].state == challongeData[i].state) {
                            pinEvent.type = "scoreChange";
                        }
                        else {  // somebody won!  change their state in SOR
                            pinEvent.type = "matchChange";
                            theMatches[i].state = challongeData.state
                        }

                        deltaEvents.push(pinEvent);

                    }
                    
                }
            }
            return deltaEvents;
        }

        // ************* PLAYER

        function startPlayerMarquee() {
            // SEND THE CURRENT STATE TO THE WIDGET
            window['taco'].emit("panelToPlayerUpdate", JSON.stringify(pinMarquee));

            console.log("playerMarquee started");
        }

        function stopPlayerMarquee() {
            clearInterval(playerMarqueeTimer);
        }

        
        // ********** ACTIVE GAME

        function startActiveGameMarquee() {

            // SEND THE CURRENT STATE TO THE WIDGET
            window['taco'].emit("panelToActiveGameUpdate", JSON.stringify(pinMarquee));

            console.log("activeGame started...");
        }

        function stopActiveGameMarquee() {
            clearInterval(activeGameTimer);
            doLogging("playerMarqueeTimer stopped...", true);
        }

        function startPolling() {
            doLogging("challonge polling started...", true);
            myTimer = setInterval(processMatches, parseInt(timerInterval));
        }

        function stopPolling() {
            clearInterval(myTimer);
            doLogging("challonge polling stopped...", true);
        }        

        function processMatches() {
            doLogging("start processMatches...", true);
            
        }

        function parseChallongeMatches(data) {
            var challongeMatches = [];
            numOfMatches = data.length;
            for (var i = 0; i < numOfMatches; i++) {
                var aMatch = new Match();
                
                aMatch.id = data[i].match.id;
                aMatch.state = data[i].match.state;
                aMatch.player1 = pinMarquee.getPlayerById(data[i].match.player1_id);
                aMatch.player2 = pinMarquee.getPlayerById(data[i].match.player2_id);
                // if there is nothing here, it's 0-0
                if (data[i].match.scores_csv == "") {
                    aMatch.matchScore = "0-0";
                }
                else {
                    aMatch.matchScore = data[i].match.scores_csv;
                }
                aMatch.round = data[i].match.round;

                aMatch.player1Score = aMatch.matchScore.substring(0, 1);
                aMatch.player2Score = aMatch.matchScore.substring(2, 3);

                //console.log(aMatch.player1Score + " " + aMatch.player2Score);
                //doLogging(aMatch, true);
                challongeMatches.push(aMatch);
            }

            console.log(challongeMatches);

            return challongeMatches;
        }

        function doLogging(logString, forceLog) {
            if (forceLog) {
                //console.log(logString);
            }

            if (logDebug) {
               // console.log(logString);
            }
        }
    </script>
</head>
<body>
    <h2>Challonge Admin Panel</h2>
    <p style="border: 1px solid black; padding: 5px">
        Nationals: <input type="text" id="tournamentId" value="c80iwk0p" size="10" /> <br />
        Womens: <input type="text" id="womensId" value="1fvxqcqw" size="10" /> <br />
        API Key: <input type="text" id="apiKey" value="FamWkhEPZ2bM6QCRVRZXZoIWatyEmRvepJf3odHx" size="50" /> <br />
        Challonge Update Interval: <input type="text" id="pollingSecs" value="60" size="4"/> seconds <br />
        <button id="loadButton">LOAD</button> 
    </p>
    <p>
        <button id="getPlayers">Load Players</button>
        <button id="getMatches">Matches</button>
        <button id="startPolling">Start Polling</button>
        <button id="stopPolling">Stop Polling</button>
        <button id="startPlayerMarquee">Start Player Marquee</button>
        <button id="stopPlayerMarquee">Stop Player Marquee</button>
        <button id="startActiveGameMarquee">Start Active Game</button>
        
    </p>

    Active Games:<br />
    <iframe width="1000" height="30" src="/activeGameWidget" scrolling="no"></iframe>

    <br /> <br />
    
    <!-- <marquee id="theMarquee" width="300" onfinish="console.log('bouncy')"></marquee><br /> 

    Past: <marquee id="previousRounds" scrollDelay="200" width="300" onfinish="console.log('bouncy')"></marquee> <br /> -->

    Current Player: <div id="currentPlayerDiv" style="width: 500">
    <iframe width="1000" height="30" src="/playerWidget" scrolling="no"></iframe>
    </div> <br />

    Event Log: <br /> 

    <iframe width="400" height="90" src="/eventWidget" scrolling="no"></iframe>

    <script>
            $(function () {

                var socket = io();
                window['taco'] = socket;
                window['taco'].emit("startWidget", "startWidget");
            });

    </script>
</body>
</html>



